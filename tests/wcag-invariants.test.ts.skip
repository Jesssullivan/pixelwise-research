import { test, expect } from 'vitest';
import { fc, it } from '@fast-check/vitest';
import {
  hexColorArbitrary,
  pulseIntensityArbitrary,
  wcagLevelArbitrary,
  calculateContrastRatio,
  backgroundColorArbitrary,
} from './arbitraries';

it.prop([hexColorArbitrary, backgroundColorArbitrary])(
  'WCAG compliance: For any valid hex color, contrast ratio should be finite and valid',
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio(textColor, backgroundColor);

    expect(contrastRatio).toBeGreaterThan(0);
    expect(contrastRatio).toBeLessThanOrEqual(21);
    expect(Number.isFinite(contrastRatio)).toBe(true);
  }
);

it.prop([
  'WCAG compliance: For pulse intensity [0, 1], output should never dip below 4.5:1 AA threshold',
  hexColorArbitrary,
  backgroundColorArbitrary,
  pulseIntensityArbitrary,
  (textColor, backgroundColor, intensity) => {
    const baseContrast = calculateContrastRatio(textColor, backgroundColor);

    if (baseContrast >= 7) {
      const minContrast = baseContrast * (1 - intensity * 0.3);
      expect(minContrast).toBeGreaterThanOrEqual(4.5);
    }
  }
);

it.prop([
  'WCAG compliance: For any text color, AA level requires minimum 4.5:1 ratio',
  hexColorArbitrary,
  backgroundColorArbitrary,
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio(textColor, backgroundColor);
    const isAACompliant = contrastRatio >= 4.5;

    if (isAACompliant) {
      expect(contrastRatio).toBeGreaterThanOrEqual(4.5);
    }
  }
);

it.prop([
  'WCAG compliance: For any text color, AAA level requires minimum 7:1 ratio',
  hexColorArbitrary,
  backgroundColorArbitrary,
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio(textColor, backgroundColor);
    const isAAACompliant = contrastRatio >= 7;

    if (isAAACompliant) {
      expect(contrastRatio).toBeGreaterThanOrEqual(7);
    }
  }
);

it.prop([
  'WCAG compliance: High contrast colors should always pass AA',
  hexColorArbitrary,
  backgroundColorArbitrary,
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio(textColor, backgroundColor);

    if (contrastRatio >= 7) {
      expect(contrastRatio).toBeGreaterThanOrEqual(4.5);
      expect(contrastRatio).toBeGreaterThanOrEqual(7);
    }
  }
);

it.prop([
  'WCAG compliance: AAA compliance implies AA compliance',
  hexColorArbitrary,
  backgroundColorArbitrary,
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio(textColor, backgroundColor);
    const isAAACompliant = contrastRatio >= 7;
    const isAACompliant = contrastRatio >= 4.5;

    if (isAAACompliant) {
      expect(isAACompliant).toBe(true);
    }
  }
);

it.prop([
  'WCAG compliance: Black text on white background should be AAA compliant',
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio('#000000', '#ffffff');

    expect(contrastRatio).toBe(21);
    expect(contrastRatio).toBeGreaterThanOrEqual(7);
    expect(contrastRatio).toBeGreaterThanOrEqual(4.5);
  }
);

it.prop([
  'WCAG compliance: White text on black background should be AAA compliant',
  (textColor, backgroundColor) => {
    const contrastRatio = calculateContrastRatio('#ffffff', '#000000');

    expect(contrastRatio).toBe(21);
    expect(contrastRatio).toBeGreaterThanOrEqual(7);
    expect(contrastRatio).toBeGreaterThanOrEqual(4.5);
  }
);

it.prop([
  'WCAG compliance: Similar colors should fail AA',
  hexColorArbitrary,
  (hex1) => {
    const r = parseInt(hex1.slice(1, 3), 16);
    const g = parseInt(hex1.slice(3, 5), 16);
    const b = parseInt(hex1.slice(5, 7), 16);

    const similarR = Math.min(255, Math.max(0, r + 10));
    const similarG = Math.min(255, Math.max(0, g + 10));
    const similarB = Math.min(255, Math.max(0, b + 10));

    const hex2 = `#${similarR.toString(16).padStart(2, '0')}${similarG
      .toString(16)
      .padStart(2, '0')}${similarB.toString(16).padStart(2, '0')}`;

    const contrastRatio = calculateContrastRatio(hex1, hex2);

    expect(contrastRatio).toBeLessThan(4.5);
  }
);

it.prop([
  'WCAG compliance: Inverse colors have maximum contrast ratio',
  hexColorArbitrary,
  (hex) => {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);

    const inverseR = 255 - r;
    const inverseG = 255 - g;
    const inverseB = 255 - b;

    const inverseHex = `#${inverseR.toString(16).padStart(2, '0')}${inverseG
      .toString(16)
      .padStart(2, '0')}${inverseB.toString(16).padStart(2, '0')}`;

    const contrastRatio = calculateContrastRatio(hex, inverseHex);

    expect(contrastRatio).toBeGreaterThan(10);
  }
);
