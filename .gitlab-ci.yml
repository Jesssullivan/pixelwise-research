# Pixelwise GitLab CI/CD Configuration
# =====================================
# Uses Nix for hermetic builds and Attic for binary caching

stages:
  - cache
  - build
  - test
  - container
  - deploy

variables:
  # Nix configuration
  NIX_CONFIG: "experimental-features = nix-command flakes"
  # Attic cache
  ATTIC_SERVER: "https://nix-cache.fuzzy-dev.tinyland.dev"
  # Container registry
  CI_REGISTRY_IMAGE: registry.gitlab.com/tinyland/pixelwise

# ============================================================================
# Shared Templates
# ============================================================================

.nix_base:
  image: nixos/nix:latest
  before_script:
    - nix profile install nixpkgs#attic-client nixpkgs#bazel_7
    - attic login production $ATTIC_SERVER $ATTIC_TOKEN
    - attic use main
  cache:
    key: nix-store-$CI_COMMIT_REF_SLUG
    paths:
      - /nix/store

.nix_cache:
  extends: .nix_base
  after_script:
    # Push all build outputs to Attic cache
    - |
      nix build .#all --json 2>/dev/null | \
        jq -r '.[].outputs.out' | \
        xargs -r attic push main || true

.retry_config:
  timeout: 10 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - job_execution_timeout

# ============================================================================
# Cache Stage
# ============================================================================

cache:warm:
  extends:
    - .nix_base
    - .retry_config
  stage: cache
  script:
    - nix flake check --no-build
    - nix build .#devShells.x86_64-linux.default --no-link
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - flake.nix
        - flake.lock

# ============================================================================
# Build Stage
# ============================================================================

build:bazel:
  extends:
    - .nix_cache
    - .retry_config
  stage: build
  script:
    # Build all targets via Bazel (includes nix2container images)
    - nix develop --command bazel build //...
    - mkdir -p artifacts
    - cp -r bazel-bin/* artifacts/ || true
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week

build:futhark:
  extends:
    - .nix_cache
    - .retry_config
  stage: build
  script:
    - nix develop --command bash -c "cd futhark && make all"
  artifacts:
    paths:
      - futhark/*.wasm
      - futhark/*.mjs
      - futhark/*.class.js
    expire_in: 1 week

# ============================================================================
# Test Stage
# ============================================================================

test:bazel:
  extends:
    - .nix_base
    - .retry_config
  stage: test
  needs: ["build:futhark"]
  script:
    # Run all tests via Bazel (with caching)
    - nix develop --command bazel test //... --config=ci
  artifacts:
    paths:
      - bazel-testlogs/
    expire_in: 1 week

test:unit:
  extends:
    - .nix_base
    - .retry_config
  stage: test
  needs: ["build:futhark"]
  script:
    - nix develop --command bash -c "pnpm install --frozen-lockfile && pnpm test"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

test:futhark:
  extends:
    - .nix_base
    - .retry_config
  stage: test
  script:
    - nix develop --command futhark test futhark/*.fut
  allow_failure: false

test:e2e:
  extends:
    - .nix_base
  stage: test
  needs: ["build:bazel"]
  timeout: 30 minutes
  script:
    - nix develop --command bash -c "pnpm install --frozen-lockfile && pnpm exec playwright install --with-deps && pnpm exec playwright test"
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# Container Stage
# ============================================================================

container:build:
  extends:
    - .nix_cache
    - .retry_config
  stage: container
  needs: ["build:bazel", "test:unit"]
  script:
    # Build production container via nix2container directly
    # (Bazel triggers nix build, but we need the tarball for artifacts)
    - mkdir -p containers
    - |
      IMAGE_PATH=$(nix build .#container-prod --no-link --print-out-paths)
      # Export to docker-archive format
      $IMAGE_PATH/bin/copyTo docker-archive:containers/pixelwise.tar
  artifacts:
    paths:
      - containers/
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

container:push:
  stage: container
  needs: ["container:build"]
  image: quay.io/skopeo/stable:latest
  script:
    - |
      skopeo copy \
        --dest-creds "${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}" \
        docker-archive:containers/pixelwise.tar \
        docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        skopeo copy \
          --dest-creds "${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}" \
          docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} \
          docker://${CI_REGISTRY_IMAGE}:latest
      fi
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        skopeo copy \
          --dest-creds "${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}" \
          docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} \
          docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ============================================================================
# Deploy Stage
# ============================================================================

deploy:staging:
  stage: deploy
  needs: ["container:push"]
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/pixelwise pixelwise=${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} -n pixelwise-staging
    - kubectl rollout status deployment/pixelwise -n pixelwise-staging --timeout=5m
  environment:
    name: staging
    url: https://staging.pixelwise.tinyland.dev
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

deploy:production:
  stage: deploy
  needs: ["deploy:staging"]
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/pixelwise pixelwise=${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG} -n pixelwise-prod
    - kubectl rollout status deployment/pixelwise -n pixelwise-prod --timeout=5m
  environment:
    name: production
    url: https://pixelwise.tinyland.dev
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

# ============================================================================
# Scheduled Jobs
# ============================================================================

cache:prune:
  extends: .nix_base
  stage: cache
  script:
    # Garbage collect old Nix store paths
    - nix-collect-garbage --delete-older-than 7d
    # Prune Attic cache
    - attic cache info main
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
